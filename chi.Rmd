---
title: "The chi square family of tests"
author: "Martin Schweinberger"
date: "2 Dezember 2018"
output: html_document
---


This tutorial introduces the $\chi^{2}$ family of tests. 

# The chi square test: a simple example

To explore how $\chi^{2}$ tests work, we will investigate whther speakers of American English (AmE) and speakers of British English (BrE) differ with respect to their preference for the near-synonyms *sort of* and *kind of*. As a first step, we formulate the $H_{1}$ and the $H_{0}$. The Alternativ- or Testhypothesis $H_{1}$ states:

$H_{1}$: Speakers of AmE and BrE differ with respect to their preference for *sort of* und *kind of*.

while the Nullhypothesis ($H_{0}$) states 

$H_{0}$ Speakers of AmE and BrE do not differ with respect to their preference for *sort of* und *kind of*.

The $H_{0}$ claims the non-existence of something (which is the more conservative position) and in our example the non-existence of a correlation between variety of English and the use of  *sort of* und *kind of*.

The question now arises what has to be the case in order to reject the $H_{0}$ in favor of the $H_{1}$.

To answer this question, we require information about the probability of error, i.e. the probability that the $H_{0}$ does indeed hold for the entire population. Before performing the $\chi^{2}$ test, we follow the convetion that the required significance level is 5 percent. In other words, we will reject the $H_{0}$ if the likelyhood for the $H_{0}$ being true is less than 5 percent given the distribution of the data. In that case, i.e. in case that the likelihood for the $H_{0}$ being true is less than 5 percent, we consider the result of the  $\chi^{2}$ test as  statistically significant. This means that the observed distribution makes it very unlikey that there is no correlation between the variety of English and the use of  *sort of* and *kind of*.

Let us now assume that we have performed a search for *sort of* and *kind of* in two corpora representing American and British English and that we have obtained the following freqeuncies:

```{r echo = F, results = 'asis'}
library(knitr)
chidata <- matrix(c(181, 655, 177, 67), nrow = 2, byrow = F)
# add column and row names
colnames(chidata) <- c("BrE", "AmE")
rownames(chidata) <- c("kindof", "sortof")
kable(chidata, caption = "Observed frequencies of *sort of* and *kind of* in American and British English")
```

In a  first step, we now have to caluculate the row and column sums of our table.



I had the same question. I have tried all solutions provided above and none of them worked... But I have found a solution that works for me, and hopefully for others too.


```{r echo = F, results = 'asis'}
library(knitr)
chidata <- matrix(c(181, 177, 358, 655, 67, 722, 836, 244, 1080), nrow = 3, byrow = F)
# add column and row names
colnames(chidata) <- c("BrE", "AmE", "Total")
rownames(chidata) <- c("kindof", "sortof", "Total")
kable(chidata, caption = "Observed frequencies of *sort of* and *kind of* in American and British English with row and column totals")
```

Next, we calculate, the values that would have expected if there was no correlation between variety of English and the use of  *sort of* and *kind of*. In order to get these "expected" freqeuncies, we apply the equation below to all cells in our table.

$\frac{Column total*Row total}{Overall total}$


In our example this means that for the cell with [+]BrE [+]kindof we get:

$\frac{836*358}{1080} = \frac{299288}{1080} = 277.1185$

For the entire table this means we get the following expected values:

```{r echo = F, results = 'asis'}
library(knitr)
chidata <- matrix(c(277.1185, 80.88148, 358, 558.8815,163.11852, 722, 836, 244, 1080), nrow = 3, byrow = F)
# add column and row names
colnames(chidata) <- c("BrE", "AmE", "Total")
rownames(chidata) <- c("kindof", "sortof", "Total")
kable(chidata, caption = "Expected frequencies of *sort of* and *kind of* in American and British English with row and column totals")
```


In a next step, we calculate the contribution of each cell to the overall $\chi^{2}$ value ($\chi^{2}$ contribution). To get $\chi^{2}$ contribution for each cell, we apply the equation below to each cell.

$\frac{(observed – expected)^{2}}{expected}$

In our example this means that for the cell with [+]BrE [+]kindof we get:

$\frac{(181 – 277.1185)^{2}}{277.1185} = \frac{-96.1185^{2}}{277.1185} = \frac{9238.766}{277.1185} = 33.33868$


For the entire table this means we get the following $\chi^{2}$ values:

```{r echo = F, results = 'asis'}
library(knitr)
chidata <- matrix(c(33.33869, 114.22602, 147.5647, 16.53082, 56.63839, 73.16921, 49.86951, 170.8644, 220.7339), nrow = 3, byrow = F)
# add column and row names
colnames(chidata) <- c("BrE", "AmE", "Total")
rownames(chidata) <- c("kindof", "sortof", "Total")
kable(chidata, caption = "Chi values of *sort of* and *kind of* in American and British English with row and column totals")
```

The sum of $\chi^{2}$ contributions in our example is 220.7339. To see if this value is staistically significant, we need to calculate the degrees of freedom because the $\chi$ distribution differes across degrees of freedom.  Degrees of freedom are calculated accroding to the equation below.

$DF = (rows -1) * (columns – 1) = (2-1) * (2-1) = 1 * 1 = 1$

In a last step, we check whether the $\chi^{2}$ value that we have calculated is higher thana critical value (in which case the correlation in our table is significant). Degrees of freedom are relevcvenat here because the critical values is dependent upon the degrees of freedom: the more degrees of freedom, the higher the critical value, i.e. the harder it is to breach ethe level of significance.

Since theer is only 1 degree of freedom in our case, we need to consider only the first column in the table of critical values below.


```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c(1, 3.84, 6.64, 10.83, 2, 5.99, 9.21, 13.82, 3, 7.82, 11.35, 16.27, 4, 9.49, 13.28, 18.47, 5, 11.07, 15.09, 20.52), ncol = 4, byrow = T)
# add column names
colnames(critval) <- c("DF", "p<.05", "p<.01", "p<.001")
kable(critval, caption = "Critical chi values for 1 to 5 degrees of freedom")
```


Since the $\chi^{2}$ value that we have calculated is much higher than the critical value provided for p<.05, we can reject the $H_{0}$ and may now claim that speakers of AmE and BrE differ with respect to their preference for *sort of* und *kind of*.


Before we summarize the results, we will calculate the effect size which is a measure for how strong the correleations are.

## Effect size

Effect sizes are important because they correlations may be highly significant but the effect between  variables can be extremely weak. The effect size is therefore a measure how strong the correlation or the explanatory and predictive power between variables is.

The effect size measure for $\chi^{2}$ tests can be either the $\phi$-coeffizient (phi-coeffizient) or Cramer's $\phi$ (Cramer's phi). The $\phi$-coeffizient is used when dealing with 2x2 tables while Cramer's $\phi$ is used when dealing with tables with more than 4 cells. The $\phi$ coeffizient can be calculated by using the equation below (N = overall sample size).

$\phi = \sqrt{\frac{\chi^{2}}{N}}$

In our case, this means:

$\phi = \sqrt{\frac{220.7339}{1080}} = \sqrt{0.2043832} = 0.4520876$

The $\phi$ coefficient varies between 0 (no effect) and 1 (perfect correlation). Für die Einteilung in schwache, moderate und starke Effekte kann man der Einteilung für $\omega$ (kleines Omega) folgen, sodass man bei Werten von .1 von schwacher, um einen Wert bei 0.3 von moderater und ab .5 von einer starken Effektstärke sprechen kann \citep[266]{buehner2009statistik}. Wir haben es in diesem Beispiel also mit einem mittleren Effekt oder Zusammenhang zu tun.

# The  chi square test in R
Bevor wir dazu kommen, wie die Ergebnisse zusammengefasst werden, werden wir im Folgenden den $\chi^{2}$ test in `R`! rechnen. Zusätzlich zu den Schritten, die wir oben durchlaufen sind, werden wir die Daten graphisch darstellen.

Im ersten Schritt laden wir die Daten ein:

```{r loaddata}
# load data
mydata <- read.table("http://martinschweinberger.de/docs/data/dt001.txt", header = F, sep = "\t", quote = "", comment.char = "")
# ad column and row names
colnames(mydata) <- c("BrE", "AmE")
rownames(mydata) <- c("kindof", "sortof")
# inspect data
mydata
```

We will now visualize the data with an association and a mosaic plot.


```{r echo=TRUE, eval=T, warning=F, message=F}
# set graphics parameter
par(mfrow=c(1, 2)) # two plots in two columns in one window
assocplot(as.matrix(mydata))
mosaicplot(mydata, shade = TRUE, type = "pearson", main = "")
par(mfrow=c(1, 1)) # restore default parameter (one plot per window)

```



Die Farbe des Mosaikplots (rechts) deutet auf einen signifikanten Unterschied hin. Auch der Assoziationsplot (links) deutet dies an indem die Verteilung der Balken in den beiden Panels gespiegelt ist. Im nächsten Schritt werden wir direkt den Test durchführen.

```{r chi}
# run chi square test
chisq.results <- chisq.test(mydata, corr = F)
# inspect results
chisq.results
```



Wir sehen, dass die Ergebnisse, die `R` uns berichtet dieselben sind, wie die, die wir vorher ausgerechnet haben. Im nächsten Schritt werden wir die Effektstärke berechnen.

```{r phi}
# calculate effect size
phi.coefficient = sqrt(chisq.results$statistic / sum(mydata) * (min(dim(mydata))-1))
# inspect effect size
phi.coefficient
```




Nach der Visualisierung der Daten, dem Testen und der Berechnung der Effektstärke können wir nun dazu übergehen uns damit zu beschäftigen, wie unsere Ergebnisse zusammengefasst werden sollten.

## Summarizing results

Man kann das Ergebnis unseres Beispiels wie folgt zusammenfassen: Ein $\chi$^{2}-Test bestätigt einen hoch signifikanten Zusammenhang mittlerer Stärke zwischen der Varietät des Englischen und der Verwendung der Heckenausdrücke \textit{sort of} und \textit{kind of} ($\chi$^{2} = 220.73, df = 1, p $<$ .001***, $\phi$ = .452).

# Notes about the chi-square test

Bei $\chi^{2}$-tests müssen mindestens 80\% der Zellen Erwartungswerte $\ge$ 5 sein, höchstens 20\% der erwarteten Werte dürfen $<$ 5 sein \citep[vgl.][98]{bortz1990verteilungsfreie} und kein Erwartungswert sollte einen Wert $<$ 1 haben \citep[vgl.][136]{bortz1990verteilungsfreie}, da sonst die Schätzung, die auf der $\chi$^{2}-Verteilung beruht, zu ungenau wird \citep{cochran1954somemethods}. Ist diese Bedingung verletzt, so sollte man \textit{Fisher's Exact Test} rechnen, der zwar sehr viel aufwendiger ist, was die Rechenleistung betrifft, aber dafür auch auf sehr kleine Stichproben angewandt werden kann. Beim Fisher's Exact Test werden die Wahrscheinlichkeiten für alle möglichen Ausgänge berechnet und dann errechnet, wie hoch die summierte Wahrscheinlichkeit ist, dass das beobachtete oder ein noch extremeres Ergebnis zustande kommen ist. Ist die summierte Wahrscheinlichkeit kleiner als 5\%, dann ist Ihr Ergebnis signifikant.

Eine andere Alternative bei kleinen Stichproben bildet die Möglichkeit eine Yates-Korrektur bei dem $\chi$^{2}-Test durchzuführen, die wir in Sektion \ref{yates} besprechen werden.

# Special chi-square tests

Im Folgenden werden einige Fälle besprochen, bei denen die Anwendung des herkömmlichen (Pearson's) $\chi$^{2}-Test inkorrekt oder problematisch wäre.

## The Yates-Correction

Die Yates-Korrektur wird in Fällen angewendet, bei denen der Stichprobenumfang relativ gering ist \citep[60$>$N$>$15,vgl.][91]{bortz1990verteilungsfreie}. Der Unterschied zum herkömmlichen Pearson's) $\chi^{2}$-Test besteht dabei darin, dass die $\chi$^{2}-Werte anstatt nach Formel (\ref{eq:chi}) nach Formel (\ref{eq:chiyates}) berechnet werden.


$\frac{(|observed – expected|-0.5)^{2}}{expected}$


Damit würde sich für unser Beispiel anstatt Tabelle ({\ref{tab:x2}) die folgende Tabelle (\ref{tab:x2yates}) führen. Es ist hierbei zu bedenken, dass in unserem Fall keine Yates-Korrektur angebracht wäre, da unsere Stichprobe den Wert von 60 Fällen stark überschreitet.

```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c("kind of", 32.9927, 113.0407, 146.0335, "sort of", 16.3593, 56.0507, 72.4100, "Total", 49.3520, 169.0914, 218.4434), ncol = 4, byrow = T)
# add column names
colnames(critval) <- c("Variant", "BrE", "AmE", "Total")
kable(critval, caption = "Corrected chi-square values for sort of and kind of in BrE and AmE")
```


Es zeigt sich, dass die Yates-Korrektur zu einem etwas geringerem $\chi$^{2}-Wert führt und sie somit zu konservativeren Ergebnissen führt, als es nach Pearson der Fall wäre.

## Chi-square within 2*k tables

Obwohl der $\chi$^{2}-Test weit verbreitet ist und insgesamt sehr robust ist, wird er doch häufig falsch verwendet. Dies geschieht insbesondere dann, wenn man den Test auf Tabellen anwendet, die mehr als zwei Spalten oder Zeilen haben. Es ist sehr wichtig festzuhalten, dass man für Untersuchungen, in denen man Teiltabellen auf Signifikanz testen möchte nicht den gewöhnlichen $\chi$^{2}-Test, sondern abgewandelte Varianten nutzen muss. Im Folgenden sollen zwei Beispiele darstellen, wie man in solchen Fällen vorgehen sollte.

Im ersten Fall handelt es sich um eine Tabelle mit 2 Spalten aber mehreren Zeilen, einer sogenannten 2*k-Tabelle. Um zu testen, ob eine der Ausprägungen in den Zeilen signifikant häufiger ist als eine andere sollte man die Formel, die von \citep[126--127]{bortz1990verteilungsfreie} dargelegt wird, implementieren.

In diesem Beispiel geht es darum, ob weiche Röntgenstrahlen sich von harten Röntgenstrahlen im Hinblick auf das Erreichen bzw. Nicht-Erreichen des Mitosestadiums bei Heuschreckenneuroblasten unterscheiden. Die zugrundeliegende Datentabelle sieht wie folgt aus.

```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c("X-ray soft",  21, 14, 35, "X-ray hard", 18, 13, 31, "Beta-rays", 24, 12, 36, "Light", 13, 30, 43, "Total", 76, 69, 145), ncol = 4, byrow = T)
# add column names
colnames(critval) <- c("", "Mitosis not reached", "Mitosis reached", "Total")
kable(critval, caption = "Data adapted from Bortz (1990: 126)")
```


Würde man einen einfachen $\chi$^{2}-Test rechnen, so würde man unterschlagen, dass die Daten in Zusammenhang mit anderen Daten erhoben wurden und somit nicht unabhängig sind. Wir werden zunächst einen einfachen (falschen) $\chi^{2}$-Test rechnen, um dann die korrekte Variante zu berechnen, und die Ergebnisse zu vergleichen.

```{r wholetable}
# load function
source("http://martinschweinberger.de/docs/scripts/x2.2k.r")
# create table generieren
chitb2 <- matrix(c(21, 14, 18, 13, 24, 12, 13, 30), byrow = T, nrow = 4)
colnames(chitb2) <- c("erreicht", "nichterreicht")
rownames(chitb2) <- c("rweich", "rhart", "beta", "licht")
# extract subtable
chitb3 <- matrix(c(21, 14, 18, 13), byrow = T, nrow = 2)
colnames(chitb3) <- c("erreicht", "nichterreicht")
rownames(chitb3) <- c("rweich", "rhart")
# simple x2-test
chisq.test(chitb3, corr = F)

x2.2k(chitb2, 1, 2)
```

Hier die Ergebnisse in tabellarischer Form.

```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c("chi-squared", 0.0255, 0.025, "p-value", 0.8732, 0.8744), ncol = 3, byrow = T)
# add column names
colnames(critval) <- c("", "chi-square" , "chi-square in 2*k-tables")
kable(critval, caption = "Table adapted from Bortz (1990: 126)")
```


Wie sich zeigt, kommen zwar beide Tests zu den gleichen Ergebnissen, jedoch unterscheiden sich die Resultate minimal.
Dies ist nicht immer der Fall, da die Ergebnisse stark variieren können!

## Chi-square within z*k tables

Eine weitere Anwendung, bei der der $\chi$^{2}-Test häufig inkorrekter Weise verwendet wird, ist das Testen von Teilen von Tabellen mit mehr als zwei Zeilen und mehr als zwei Spalten, d.h. z*k-Tabellen (z: Zeile, k: Kolumne). Ein Beispiel wird in \citep{gries2014frequency} besprochen, der auch das \verb!R!-Skript für die korrekte Version des $\chi^{2}$-Test erstellt hat.

Laden wir zuerst die Daten, die in dem Beispiel von \citep[9]{gries2014frequency} besprochen werden, in dem es darum geht, ob sich nicht nur Register und EMOTION-Metaphern unterscheiden, sondern auch darum, ob sich gesprochene Konversationen von Fiktion im Gebrach von EMOTION IST LICHT und EMOTION IST EINE NATURKRAFT unterscheiden.

```{r fullmatrix}
# create table
x <- matrix(c(8, 31, 44, 36, 5, 14, 25, 38, 4, 22, 17, 12, 8, 11, 16, 24), ncol=4)
attr(x, "dimnames")<-list(Register=c("acad", "spoken", "fiction", "new"),
Metaphor = c("Heated fluid", "Light", "NatForce", "Other"))
```


Es ergibt sich aus diesen Daten Tabelle (\ref{tab:chisub}).


```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c("acad", 8, 5, 4, 8, "spoken", 31, 14, 22, 11, "fiction", 44, 25, 17, 16, "new", 36, 38, 12, 24), ncol = 5, byrow = T)
# add column names
colnames(critval) <- c("Register", "Heated fluid", "Light", "NatForce", "Other")
kable(critval, caption = "Table adapted from Gries (2014: 9)")
```


Würden wir einen normalen (hier inkorrekten) $\chi$^{2}-Test verwenden, so würde sich ergeben, dass sich gesprochene Konversationen nicht signifikant von Fiktion im Gebrach von EMOTION IST LICHT und EMOTION IST EINE NATURKRAFT unterscheiden ($\chi^{2}$=3.3016, df=1, p$=$.069, $\phi$ = .2057).

```{r wrongsubtable}
# create table
subtable <- matrix(c(14, 25, 22, 17), ncol=2)
chisq.results <- chisq.test(subtable, correct=FALSE) # WRONG!
phi.coefficient = sqrt(chisq.results$statistic / sum(subtable) * (min(dim(subtable))-1))
chisq.results
phi.coefficient
```

Die korrekte Analyse berücksichtigt hierbei, dass es sich um eine Untertabelle handelt, die nicht unabhängig von der Gesamttabelle ist. Dies bedeutet, dass die korrekte Analyse die gesamte Anzahl der Fälle, sowie die Gesamtzeilen- und Gesamtspaltensummen zu berücksichtigen sind \citep[vgl.][144--148]{bortz1990verteilungsfreie}.

Um die korrekte Analyse durchführen zu können, muss die Analyse von Funktion von \citep[144--148]{bortz1990verteilungsfreie} implementiert oder direkt die Funktion von Gries eingelesen und auf die Teiltabelle angewandt werden.

```{r subtable}
# load function for chi square test for subtables
source("http://martinschweinberger.de/docs/scripts/sub.table.r") 
# apply test
results <- sub.table(x, 2:3, 2:3, out="short")
# inspect results
results
```


The results show that the difference is, in fact, statistically significant  ($\chi^{2}$=3.864, df=1, p=.049*).


# Excercises

1.Sie sind interessiert daran, ob junge oder alte Sprecher häufiger sprachlich auf sich selbst verweisen, da Sie die Hypothese haben, dass -- im Gegensatz zur weitläufig gängigen Ansicht -- ältere Menschen eher narzisstisch sind als jüngere Menschen. Sie extrahieren aus einem Korpus folgende Verteilung.

```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c("Jung", 61, 43, 104, "Alt", 42, 36, 78, "Total", 103, 79, 182), ncol = 4, byrow = T)
# add column names
colnames(critval) <- c("", "1SGPN", "PN without 1SG", "Total")
kable(critval, caption = "Table adapted from Gries (2014: 9)")
```

Rechnen Sie nun einen $\chi^{2}$ test und fassen Sie Ihre Ergebnisse korrekt zusammen.

2. Sie sind nun daran interessiert, ob junge Männer oder junge Frauen häufiger das Wort *whatever* verwenden, da Sie davon ausgehen, dass entgegen einiger früherer Beobachtungen junge Männer häufiger *whatever* nutzen als junge Frauen. Sie extrahieren aus einem Korpus folgende Verteilung.

```{r echo = F, results = 'asis'}
library(knitr)
critval <- matrix(c("whatever", 17, 55, 71, "other words", 345128, 916552, 1261680, "Total", 345145, 916607, 1261752), ncol = 4, byrow = T)
# add column names
colnames(critval) <- c("", "YoungMales", "YoungFemales", "Total")
kable(critval, caption = "Observed frequency with row- and column totals for the use of *whatever* by male and female speakers.")
```


Rechnen Sie nun einen $\chi^{2}$ test und fassen Sie Ihre Ergebnisse korrekt zusammen.

3.  Suchen Sie sich einen Partner und diskutieren das Verhältnis von Signifikanzwert und Effektstärke. Suchen Sie sich nun einen anderen Partner und sprechen Sie über potentielle Probleme, die entstehen, wenn man die Häufigkeit von Wörtern gegenüber allen anderen Wörtern testet.


