---
title: "Power Analysis in R"
author: "Martin Schweinberger"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:  
    includes:
      in_header: GoogleAnalytics.html
bibliography: bibliography.bib
link-citations: yes
---

<!--html_preserve-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130562131-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130562131-1');
</script>
<!--/html_preserve-->

```{r uq1, echo=F, fig.cap="", message=FALSE, warning=FALSE, out.width='100%'}
knitr::include_graphics("https://slcladal.github.io/images/uq1.jpg")
```

# Introduction{-}

This tutorial introduces power analysis using R. The entire R markdown document for this tutorial can be downloaded [here](https://slcladal.github.io/pwr.Rmd). The basis for the present tutorial is @green2016simr (which you can find [here](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12504)). @green2016simr is a highly recommendable and thorough tutorial on performing power analysis in R. Recommendable literature on this topic are, e.g. @arnold2011simulation and @johnson2015power.  

Power analysis is a method primarily used to determine the appropriate sample size for empirical studies. Power analysis have also been used post-hoc to test if the sample size of studies was sufficient to detect meaningful effects. 

## Preparation and session set up{-}

This tutorial is based on R. If you have not installed R or are new to it, you will find an introduction to and more information how to use R [here](https://slcladal.github.io/Intror.html). For this tutorials, we need to install certain *packages* from an R *library* so that the scripts shown below are executed without errors. Before turning to the code below, please install the packages by running the code below this paragraph. If you have already installed the packages mentioned below, then you can skip ahead and ignore this section. To install the necessary packages, simply run the following code - it may take some time (between 1 and 5 minutes to install all of the libraries so you do not need to worry if it takes some time).

```{r prep1, echo=T, eval = F, message=FALSE, warning=FALSE}
# set options
options(stringsAsFactors = F)         # no automatic data transformation
options("scipen" = 100, "digits" = 4) # suppress math annotation
# install libraries
install.packages(c("tidyverse", "lme4", "sjPlot", "simr"))
```

```{r prep2, echo=F, eval = T, message=FALSE, warning=FALSE}
library(DT)
library(knitr)
library(flextable)
```

Once you have installed R and RStudio and initiated the session by executing the code shown above, you are good to go.

# Power Analysis

Generate data and load tidyverse package to process the data.

```{r pwr1, message=F, warning=F}
# load package
library(tidyverse)
# generate data
simdat <- data.frame(
  sub <- rep(paste0("Sub", 1:20), each = 50),
  cond <- rep(c(
    rep("Cond1", 10),
    rep("Cond2", 10),
    rep("Cond3", 10),
    rep("Cond4", 10),
    rep("Cond5", 10)
  ), 20),
  itm <- as.character(rep(1:10, 100)),
  dep <- sample(c("AOI", "NotAOI"), 500, replace = T)
) %>%
  dplyr::rename(Subject = 1,
                Condition = 2,
                Item = 3,
                AOI = 4) %>%
  dplyr::mutate_if(is.character, factor)
```

The data looks like this. Each sentence (item) 

```{r pwr3, echo = F}
DT::datatable(simdat, rownames = FALSE, filter="none", caption = "Overview of the data set.", 
              options = list(pageLength = 10, scrollX=T))
```


Fit model

```{r pwr4}
# load package
library(lme4)
# set seed for replicability
set.seed(12345)
# fit model
m1 <- glmer(AOI ~ (1|Subject) +(1|Item) + Condition, family="binomial", data=simdat)
# inspect results
summary(m1)
```


Check effects of model

Tabulate results

```{r pwr5, message=F, warning=F}
# load package
library(sjPlot)
# tabulate results
sjPlot::tab_model(m1)
```

Visualize results

```{r pwr6}
# visualize effects
sjPlot::plot_model(m1)
```

Perform power analysis on observed effect

```{r pwr7, message=F}
# load package
library(simr)
# set seed for replicability
set.seed(12345)
# perform power analysis for present model
powerSim(m1, fixed("ConditionCond2", "z"), nsim=100)
```


The power analysis confirms that the sample size is insufficient given the observed effect. Given the data, we can only detect the effect of Conidition:Cond2 with an accuracy of 13% (lower ci 7.11, higher ci 21.20). The target is a standard of 80 percent accuracy!

We will now check if the sample size is sufficient to detect a small effect (Cohen's d 0.2). According to @chen2010big odds ratios of 1.68, 3.47, and 6.71 are equivalent to Cohen's d = 0.2 (small), 0.5 (medium), and 0.8 (large) - the traditional scale is 0.2 for a small, 0.5 for medium sized, and 0.8 for a large or strong effect. We need to determine the odds ratios of the fixed effects and then convert them into Cohen's d values for which we have associations between traditional denominations (small, medium, and large) and effect sife values. 


```{r pwr8, message=FALSE, warning=FALSE}
estimatesfixedeffects <- fixef(m1)
exp(estimatesfixedeffects)
```

We will now change the size of the effect of ConditionCond2 to make it *small*, i.e. on the brink of being noise but being just strong enough to be considered small. In other words, we will set the effect so that its odds ratio is exactly 1.68.  


```{r pwr9, message=FALSE, warning=FALSE}
# set seed for replicability
set.seed(12345)
# perform power analysis for small effect
fixef(m1)["ConditionCond2"] <- 0.519
estimatesfixedeffects <- fixef(m1)
exp(estimatesfixedeffects)
```



Now we can test if the sample size of the model is sufficient to find a small effect. 

```{r pwr10, message=FALSE, warning=FALSE}
# set seed for replicability
set.seed(12345)
# perform power analysis for present model
powerSim(m1, fixed("ConditionCond2", "z"), nsim=100)
```

The power analysis shows that the data is sufficient to detect a small effect for Condition:Cond2 with 79% accuracy.

# Citation & Session Info {-}

Schweinberger, Martin. `r format(Sys.time(), '%Y')`. *Power Analysis in R*. Brisbane: The University of Queensland. url: https://slcladal.github.io/clust.html (Version `r format(Sys.time(), '%Y.%m.%d')`).

```
@manual{schweinberger`r format(Sys.time(), '%Y')`pwr,
  author = {Schweinberger, Martin},
  title = {Power Analysis in R},
  note = {https://slcladal.github.io/pwr.html},
  year = {`r format(Sys.time(), '%Y')`},
  organization = "The University of Queensland, Australia. School of Languages and Cultures},
  address = {Brisbane},
  edition = {`r format(Sys.time(), '%Y.%m.%d')`}
}
```


```{r fin}
sessionInfo()
```


***

[Back to top](#introduction)

[Back to HOME](https://slcladal.github.io/index.html)

***

# References {-}
